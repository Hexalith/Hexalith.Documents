@using Hexalith.Application.Commands
@using System.Security.Claims
@using Hexalith.Application.Requests
@using Hexalith.Application.Sessions.Services
@using Hexalith.Documents.Commands.Documents
@using Hexalith.Extensions.Helpers
@inject IStringLocalizer<Labels> L
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager
@inject ICommandService CommandService
@inject IRequestService RequestService
@inject ISessionService SessionService
@inject IToastService ToastService
@inject TimeProvider TimeProvider
<HexEntitySummaryGrid Items="Items"
					  TIdDescription="DocumentSummaryViewModel"
					  ShowDisabledColumn="ShowDisabledColumn"
					  OnDisabledChanged="OnDisabledChanged"
					  SearchChanged="OnSearchChanged"
					  EntityDetailsPath="@EntityDetailsPath">
	@if (!HideContainerColumn)
	{
		<PropertyColumn TGridItem="DocumentSummaryViewModel" TProp="string" Property="@(p => p.DocumentContainerId)" Title="@(L[nameof(Labels.Container)])"></PropertyColumn>
	}
	<PropertyColumn TGridItem="DocumentSummaryViewModel" TProp="long" Property="@(p => p.Size)" Title="@(L[nameof(Labels.Size)])"></PropertyColumn>
	<TemplateColumn Style="display: flex; align-items: center;" TGridItem="DocumentSummaryViewModel">
		<DocumentDownloadAnchors DocumentId="@context.Id" OnDocumentLink="OnCreateDocumentLinkAsync" />
	</TemplateColumn>

</HexEntitySummaryGrid>


@code {
	/// <summary>
	/// Gets or sets a value indicating whether the column displaying disabled status of items should be shown.
	/// </summary>
	[Parameter]
	public bool ShowDisabledColumn { get; set; }

	[Parameter]
	public bool HideContainerColumn { get; set; }

	[Parameter]
	[EditorRequired]
	public ClaimsPrincipal? User { get; set; }

	/// <summary>
	/// Gets or sets the callback when the disabled state changes.
	/// </summary>
	[Parameter]
	public EventCallback<string> OnDisabledChanged { get; set; }

	/// <summary>
	/// Gets or sets the callback when a row is double clicked.
	/// </summary>
	[Parameter]
	public string? EntityDetailsPath { get; set; } = "/Documents/Document";

	[Parameter]
	public string? DocumentContainerId { get; set; }

	private IQueryable<DocumentSummaryViewModel> Items { get; set; } = Enumerable.Empty<DocumentSummaryViewModel>().AsQueryable();

	private string? Search { get; set; }


	protected override async Task OnInitializedAsync()
	{
		await LoadSummaries();
		await base.OnInitializedAsync();
	}

	private async Task OnSearchChanged(string search)
	{
		Search = search;
		await LoadSummaries();
	}

	private async Task OnCreateDocumentLinkAsync(string id)
	{
		try
		{
			if (User is null || string.IsNullOrWhiteSpace(User.Identity?.Name))
			{
				return;
			}
			var session = await SessionService.GetAsync(User.Identity.Name, CancellationToken.None);
			var key = UniqueIdHelper.GenerateUniqueStringId();
			await CommandService.SubmitCommandAsync(
				User,
				new AddDocumentAccessKey(
					id,
					new(key, TimeProvider.GetLocalNow().AddDays(90))),
				CancellationToken.None);
			// Create the download URL using the NavigationManager
			var baseUri = NavigationManager.BaseUri;
			var downloadUrl = $"{baseUri}documents/download/{session.PartitionId}/{id}/{key}";

			// Use JSRuntime to copy the URL to clipboard
			await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", downloadUrl);

			ToastService.ShowSuccess(L[nameof(Labels.DownloadLinkCopiedToCliboard)]);
		}
		catch (Exception ex)
		{
			ToastService.ShowError(L[nameof(Labels.DownloadLinkFailed), ex.FullMessage()]);
		}
	}
	private async Task LoadSummaries()
	{
		if (User is null || string.IsNullOrWhiteSpace(User.Identity?.Name))
		{
			return;
		}
		IEnumerable<DocumentSummaryViewModel> results;
		if (string.IsNullOrWhiteSpace(DocumentContainerId))
		{
			results = (await RequestService.SubmitAsync(
				User,
				new GetDocumentSummaries(0, 50, Search),
				CancellationToken.None)).Results;
		}
		else
		{
			results = (await RequestService
						.SubmitAsync(User, new GetDocumentsInContainer(DocumentContainerId), CancellationToken.None))
						.Results
						.OrderBy(p => p.Id);
		}
		if (!results.Any() && string.IsNullOrWhiteSpace(Search) && string.IsNullOrWhiteSpace(DocumentContainerId))
		{
			await CommandService.SubmitCommandsAsync(User, DocumentQuickStartData.Data, CancellationToken.None);
		}
		Items = (results ?? []).AsQueryable();
	}
}
